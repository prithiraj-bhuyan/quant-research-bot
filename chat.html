<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Quant Finance Research Portal</title>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body { font-family: 'Courier New', monospace; background: #0a0a0a; color: #e0e0e0; height: 100vh; display: flex; flex-direction: column; }

  /* Header */
  .header { padding: 12px 20px; background: #111; border-bottom: 1px solid #333; display: flex; align-items: center; justify-content: space-between; }
  .header h1 { font-size: 14px; color: #00ff88; letter-spacing: 1px; }
  .header .status { font-size: 11px; color: #666; }
  .header .status.online { color: #00ff88; }

  /* Sidebar toggle */
  .layout { display: flex; flex: 1; overflow: hidden; }
  .sidebar { width: 260px; background: #0f0f0f; border-right: 1px solid #222; padding: 12px; overflow-y: auto; font-size: 12px; }
  .sidebar h3 { color: #888; font-size: 11px; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px; }
  .sidebar label { display: block; margin: 6px 0 2px; color: #aaa; }
  .sidebar input, .sidebar select { width: 100%; padding: 6px; background: #1a1a1a; border: 1px solid #333; color: #e0e0e0; font-family: inherit; font-size: 12px; margin-bottom: 4px; }
  .sidebar button { width: 100%; padding: 8px; margin-top: 8px; background: #1a1a1a; border: 1px solid #333; color: #00ff88; cursor: pointer; font-family: inherit; font-size: 12px; }
  .sidebar button:hover { background: #222; }
  .sidebar .info { color: #555; font-size: 10px; margin-top: 4px; }

  /* Chat area */
  .chat-area { flex: 1; display: flex; flex-direction: column; }
  .messages { flex: 1; overflow-y: auto; padding: 16px; }
  .msg { margin-bottom: 16px; max-width: 85%; }
  .msg.user { margin-left: auto; }
  .msg.assistant { margin-right: auto; }
  .msg .bubble { padding: 10px 14px; border-radius: 4px; font-size: 13px; line-height: 1.6; white-space: pre-wrap; word-wrap: break-word; }
  .msg.user .bubble { background: #1a2a1a; border: 1px solid #2a4a2a; color: #c0e0c0; }
  .msg.assistant .bubble { background: #1a1a1a; border: 1px solid #2a2a2a; }
  .msg .meta { font-size: 10px; color: #555; margin-top: 4px; padding: 0 4px; }

  /* Citations */
  .citations { margin-top: 8px; padding-top: 8px; border-top: 1px solid #222; }
  .citation { font-size: 11px; color: #888; padding: 3px 0; display: flex; gap: 8px; }
  .citation .num { color: #00ff88; min-width: 20px; }
  .citation .detail { color: #666; }

  /* Timings */
  .timings { font-size: 10px; color: #444; margin-top: 6px; }
  .timings span { margin-right: 12px; }

  /* Input */
  .input-area { padding: 12px 16px; background: #0f0f0f; border-top: 1px solid #222; display: flex; gap: 8px; }
  .input-area input { flex: 1; padding: 10px 14px; background: #1a1a1a; border: 1px solid #333; color: #e0e0e0; font-family: inherit; font-size: 13px; outline: none; }
  .input-area input:focus { border-color: #00ff88; }
  .input-area button { padding: 10px 20px; background: #00ff88; color: #000; border: none; cursor: pointer; font-family: inherit; font-weight: bold; font-size: 13px; }
  .input-area button:disabled { background: #333; color: #666; cursor: not-allowed; }

  /* Loading */
  .loading { display: inline-block; }
  .loading::after { content: ''; animation: dots 1.5s infinite; }
  @keyframes dots { 0% { content: '.'; } 33% { content: '..'; } 66% { content: '...'; } }
</style>
</head>
<body>

<div class="header">
  <h1>â–² QUANT FINANCE RESEARCH PORTAL</h1>
  <div class="status" id="statusIndicator">checkingâ€¦</div>
</div>

<div class="layout">
  <!-- Sidebar -->
  <div class="sidebar">
    <h3>âš™ Settings</h3>

    <label>Top-K Results</label>
    <input type="number" id="topK" value="5" min="1" max="20">

    <label>Use Reranker</label>
    <select id="useReranker">
      <option value="true" selected>Yes (cross-encoder)</option>
      <option value="false">No (faster)</option>
    </select>

    <h3 style="margin-top: 16px;">ğŸ“¥ Papers</h3>
    <label>Fetch from arXiv</label>
    <input type="number" id="fetchCount" value="20" min="1" max="100">
    <button onclick="fetchPapers()">Fetch Papers</button>

    <h3 style="margin-top: 16px;">ğŸ”§ Index</h3>
    <button onclick="buildIndex(false)">Build / Update Index</button>
    <button onclick="buildIndex(true)">Full Rebuild</button>
    <button onclick="checkBuildStatus()">Check Build Status</button>
    <div class="info" id="buildInfo">â€”</div>

    <h3 style="margin-top: 16px;">ğŸ§ª Evaluation</h3>
    <button onclick="runEval()">Run Eval (20 queries)</button>
    <button onclick="getEvalReport()">View Report</button>
    <div class="info" id="evalInfo">â€”</div>
  </div>

  <!-- Chat -->
  <div class="chat-area">
    <div class="messages" id="messages">
      <div class="msg assistant">
        <div class="bubble">Ready. Ask me anything about quantitative finance research.
Type a question to search across your paper corpus with hybrid retrieval + reranking.</div>
      </div>
    </div>

    <div class="input-area">
      <input type="text" id="queryInput" placeholder="Ask about portfolio optimization, risk measures, pricing modelsâ€¦"
             onkeydown="if(event.key==='Enter') sendMessage()">
      <button id="sendBtn" onclick="sendMessage()">ASK</button>
    </div>
  </div>
</div>

<script>
const API = '';  // same origin
let conversationHistory = [];

// â”€â”€ Check index status on load â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function checkStatus() {
  try {
    const r = await fetch(`${API}/indexStatus`);
    const d = await r.json();
    const el = document.getElementById('statusIndicator');
    if (d.config) {
      el.textContent = `INDEX: ${d.config.total_vectors} vectors | ${d.config.model_name}`;
      el.className = 'status online';
    } else {
      el.textContent = 'NO INDEX â€” build one first';
      el.className = 'status';
    }
  } catch { document.getElementById('statusIndicator').textContent = 'API offline'; }
}
checkStatus();

// â”€â”€ Chat â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function sendMessage() {
  const input = document.getElementById('queryInput');
  const query = input.value.trim();
  if (!query) return;

  input.value = '';
  document.getElementById('sendBtn').disabled = true;

  // Add user message
  addMessage('user', query);

  // Add loading
  const loadingId = addMessage('assistant', '<span class="loading">Searching & generating</span>', true);

  const topK = parseInt(document.getElementById('topK').value) || 5;
  const useReranker = document.getElementById('useReranker').value === 'true';

  try {
    const r = await fetch(`${API}/chat`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        query,
        conversation_history: conversationHistory.slice(-6),
        top_k: topK,
        use_reranker: useReranker,
      }),
    });
    const d = await r.json();

    // Remove loading
    document.getElementById(loadingId)?.remove();

    // Build citations HTML
    let citationsHtml = '';
    if (d.citations && d.citations.length) {
      citationsHtml = '<div class="citations">';
      d.citations.forEach((c, i) => {
        const page = c.page_number > 0 ? `p.${c.page_number}` : '';
        citationsHtml += `<div class="citation">
          <span class="num">[${i+1}]</span>
          <span>${c.paper_title}</span>
          <span class="detail">Â§${c.section} ${page} (${c.category})</span>
        </div>`;
      });
      citationsHtml += '</div>';
    }

    // Timings
    const t = d.timings || {};
    const timingsHtml = `<div class="timings">
      <span>retrieval: ${t.retrieval_ms || 0}ms</span>
      <span>rerank: ${t.rerank_ms || 0}ms</span>
      <span>generation: ${t.generation_ms || 0}ms</span>
      <span>chunks: ${d.context_chunks_used || 0}</span>
      <span>model: ${d.model_used || 'â€”'}</span>
    </div>`;

    addMessage('assistant', escapeHtml(d.answer || 'No answer.') + citationsHtml + timingsHtml, true);

    // Update conversation history
    conversationHistory.push({ role: 'user', content: query });
    conversationHistory.push({ role: 'assistant', content: d.answer || '' });

  } catch (e) {
    document.getElementById(loadingId)?.remove();
    addMessage('assistant', `âŒ Error: ${e.message}`);
  }

  document.getElementById('sendBtn').disabled = false;
  document.getElementById('queryInput').focus();
}

function addMessage(role, content, isHtml = false) {
  const div = document.createElement('div');
  div.className = `msg ${role}`;
  const id = 'msg-' + Date.now() + Math.random().toString(36).substr(2, 5);
  div.id = id;
  div.innerHTML = `<div class="bubble">${isHtml ? content : escapeHtml(content)}</div>`;
  document.getElementById('messages').appendChild(div);
  div.scrollIntoView({ behavior: 'smooth' });
  return id;
}

function escapeHtml(text) {
  const d = document.createElement('div');
  d.textContent = text;
  return d.innerHTML;
}

// â”€â”€ Sidebar actions â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function fetchPapers() {
  const count = parseInt(document.getElementById('fetchCount').value) || 20;
  document.getElementById('buildInfo').textContent = 'Fetching papersâ€¦';
  try {
    const r = await fetch(`${API}/getPapers`, {
      method: 'POST', headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ max_papers: count }),
    });
    const d = await r.json();
    document.getElementById('buildInfo').textContent = `âœ… Downloaded ${d.downloaded} papers`;
  } catch (e) {
    document.getElementById('buildInfo').textContent = `âŒ ${e.message}`;
  }
}

async function buildIndex(forceRebuild) {
  const endpoint = forceRebuild ? '/rebuildEmbeddings' : '/buildEmbeddings';
  document.getElementById('buildInfo').textContent = 'Starting buildâ€¦';
  try {
    const r = await fetch(`${API}${endpoint}`, {
      method: 'POST', headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ chunk_size: 500, overlap: 80, force_rebuild: forceRebuild }),
    });
    const d = await r.json();
    document.getElementById('buildInfo').textContent = `${d.status} â€” ${d.mode}. Poll /buildStatus.`;
    // Auto-poll
    setTimeout(checkBuildStatus, 3000);
  } catch (e) {
    document.getElementById('buildInfo').textContent = `âŒ ${e.message}`;
  }
}

async function checkBuildStatus() {
  try {
    const r = await fetch(`${API}/buildStatus`);
    const d = await r.json();
    const info = document.getElementById('buildInfo');
    if (d.state === 'building') {
      info.textContent = `â³ Buildingâ€¦ ${d.detail || ''}`;
      setTimeout(checkBuildStatus, 3000);
    } else if (d.state === 'done') {
      const det = d.detail || {};
      info.textContent = `âœ… Done â€” ${det.chunks || det.total_chunks || '?'} chunks`;
      checkStatus();
    } else if (d.state === 'error') {
      info.textContent = `âŒ ${d.detail}`;
    } else {
      info.textContent = `State: ${d.state}`;
    }
  } catch (e) {
    document.getElementById('buildInfo').textContent = `âŒ ${e.message}`;
  }
}

async function runEval() {
  document.getElementById('evalInfo').textContent = 'Running evaluationâ€¦';
  try {
    const r = await fetch(`${API}/evaluate`, {
      method: 'POST', headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ mode: 'embedding', num_queries: 20 }),
    });
    const d = await r.json();
    document.getElementById('evalInfo').textContent = `${d.status} â€” ${d.queries} queries (${d.mode})`;
  } catch (e) {
    document.getElementById('evalInfo').textContent = `âŒ ${e.message}`;
  }
}

async function getEvalReport() {
  try {
    const r = await fetch(`${API}/evalReport`);
    const d = await r.json();
    if (d.avg_context_precision !== undefined) {
      const summary = `CP: ${d.avg_context_precision} | AR: ${d.avg_answer_relevancy} | FF: ${d.avg_faithfulness}`;
      document.getElementById('evalInfo').textContent = summary;
      addMessage('assistant',
        `ğŸ“Š Evaluation Report (${d.mode})\n` +
        `Queries: ${d.total_queries}\n` +
        `Context Precision: ${d.avg_context_precision}\n` +
        `Answer Relevancy:  ${d.avg_answer_relevancy}\n` +
        `Faithfulness:      ${d.avg_faithfulness}\n` +
        `Avg Retrieval:     ${d.avg_retrieval_ms}ms\n` +
        `Avg Rerank:        ${d.avg_rerank_ms}ms\n` +
        `Avg Generation:    ${d.avg_generation_ms}ms`
      );
    } else {
      document.getElementById('evalInfo').textContent = d.message || 'No report yet.';
    }
  } catch (e) {
    document.getElementById('evalInfo').textContent = `âŒ ${e.message}`;
  }
}
</script>
</body>
</html>